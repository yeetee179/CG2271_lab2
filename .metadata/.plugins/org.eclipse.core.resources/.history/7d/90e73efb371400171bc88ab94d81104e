#include <Arduino.h>
#include <avr/io.h>
#include <FreeRTOS.h>
#include <task.h>
#include <semphr.h>
#include <queue.h>

#define STACK_SIZE 200

unsigned long current_interrupt_time;
static unsigned long previous_Interrupt_time = 0;

xSemaphoreHandle semaphore;
static BaseType_t xHigherPriorityTaskWoken;

void int0task(void *p){
	while(1){
		if( xSemaphoreTake( semaphore, 999999 ) == pdTRUE ){
			for(int i=0; i<5; i++){
				digitalWrite(7, HIGH); // Set digital I/O pin to a 1
				delay(125); // Delay
				digitalWrite(7, LOW); // Set digital I/O pin to a 0
				delay(125);
			}
		}
	}
}

// Flashes LED at pin 6: 5 times at 2HZ
void int1task(void * p){
	if( xSemaphoreTake( semaphore,  ) == pdTRUE ){
		for(int i=0; i<5; i++){
			digitalWrite(6, HIGH); // Set digital I/O pin to a 1
			delay(250); // Delay
			digitalWrite(6, LOW); // Set digital I/O pin to a 0
			delay(250);
		}
	}
}

void int0ISR(){
	BaseType_t xHigherPriorityTaskWoken = 0;
	current_interrupt_time = millis();
	if((current_interrupt_time - previous_Interrupt_time) > 200){
		xSemaphoreGiveFromISR( semaphore, &xHigherPriorityTaskWoken );
	}
	previous_Interrupt_time = current_interrupt_time;
	if (xHigherPriorityTaskWoken){
	    taskYIELD();
	}
}

void int1ISR(){
	BaseType_t xHigherPriorityTaskWoken = 0;
	current_interrupt_time = millis();
	if((current_interrupt_time - previous_Interrupt_time) > 200){
		xSemaphoreGiveFromISR( semaphore, &xHigherPriorityTaskWoken);
	}
	previous_Interrupt_time = current_interrupt_time;
	if (xHigherPriorityTaskWoken){
	    taskYIELD();
	}
}

void setup() {
	attachInterrupt(digitalPinToInterrupt(3), int0ISR, FALLING); //deals with interrupt of pin 2
	attachInterrupt(digitalPinToInterrupt(2), int1ISR, FALLING); // deals with interrupt of pin 3
	pinMode(7, OUTPUT);
	pinMode(6, OUTPUT);
}

void loop() {
	semaphore = xSemaphoreCreateBinary();

	xTaskCreate(int1task, "Task1", STACK_SIZE, NULL, 1, NULL);
	xTaskCreate(int0task, "Task2", STACK_SIZE, NULL, 2, NULL);
	vTaskStartScheduler();
}

